name: Universal Repo to NotebookLM

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: '目标 GitHub 项目 URL'
        required: true
        type: string
      branch:
        description: '分支名 (留空则自动使用默认分支)'
        required: false
        default: ''

jobs:
  build-and-sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Tool Scripts
      uses: actions/checkout@v4
      with:
        path: tools

    - name: Clone Target Repository
      run: |
        echo "Cloning: ${{ inputs.repo_url }}"
        if [ -z "${{ inputs.branch }}" ]; then
          git clone --depth 1 ${{ inputs.repo_url }} target_codebase
        else
          git clone --depth 1 --branch ${{ inputs.branch }} ${{ inputs.repo_url }} target_codebase
        fi

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2

    # [修改点] 提取项目名，并生成对应文件名的 Markdown
    - name: Generate Context Markdown
      run: |
        # 1. 从 URL 提取项目名称 (例如: vibe-coding-cn)
        REPO_NAME=$(basename "${{ inputs.repo_url }}" .git)
        echo "📂 Detected Repo Name: $REPO_NAME"
        
        # 2. 构造文件名 (例如: vibe-coding-cn.md)
        FILENAME="${REPO_NAME}.md"
        
        # 3. 将文件名保存到 GitHub Environment 变量中，供后续步骤使用
        echo "TARGET_FILENAME=$FILENAME" >> $GITHUB_ENV
        
        # 4. 运行转换脚本，指定输出文件名为刚才构造的名字
        python tools/repo2txt.py target_codebase -o "$FILENAME"
        
        echo "📄 Generated file: $FILENAME"

    # [修改点] 传入 TARGET_FILENAME 环境变量
    - name: Upload to Google Drive
      env:
        GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
        GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
        GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        TARGET_FILENAME: ${{ env.TARGET_FILENAME }} # 读取上一步设置的变量
      run: |
        python tools/upload_to_drive.py
