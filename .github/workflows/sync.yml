name: Universal Repo to NotebookLM (PDF Version)

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'ç›®æ ‡ GitHub é¡¹ç›® URL'
        required: true
        type: string
      branch:
        description: 'åˆ†æ”¯å (ç•™ç©ºåˆ™è‡ªåŠ¨é»˜è®¤)'
        required: false
        default: ''

jobs:
  build-and-sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Tool Scripts
      uses: actions/checkout@v4
      with:
        path: tools

    - name: Clone Target Repository
      run: |
        echo "Cloning: ${{ inputs.repo_url }}"
        if [ -z "${{ inputs.branch }}" ]; then
          git clone --depth 1 ${{ inputs.repo_url }} target_codebase
        else
          git clone --depth 1 --branch ${{ inputs.branch }} ${{ inputs.repo_url }} target_codebase
        fi

    # [æ–°å¢ž] å®‰è£… Linux ç³»ç»Ÿåº“ (WeasyPrint éœ€è¦)
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libpango-1.0-0 libpangoft2-1.0-0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # [ä¿®æ”¹] å®‰è£… Python åº“ (å¢žåŠ  markdown å’Œ weasyprint)
    - name: Install dependencies
      run: |
        pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2
        pip install markdown weasyprint

    # [æ ¸å¿ƒä¿®æ”¹] ç”Ÿæˆ MD -> è½¬ PDF
    - name: Generate PDF Context
      run: |
        REPO_NAME=$(basename "${{ inputs.repo_url }}" .git)
        
        # å®šä¹‰æ–‡ä»¶å
        MD_FILE="${REPO_NAME}.md"
        PDF_FILE="${REPO_NAME}.pdf"
        
        echo "ðŸ“‚ Processing: $REPO_NAME"
        
        # 1. å…ˆç”Ÿæˆ Markdown (ä¸­é—´æ–‡ä»¶)
        python tools/repo2txt.py target_codebase -o "$MD_FILE"
        
        # 2. å†è½¬æˆ PDF (æœ€ç»ˆæ–‡ä»¶)
        python tools/md2pdf.py "$MD_FILE" "$PDF_FILE"
        
        # 3. è®¾ç½®çŽ¯å¢ƒå˜é‡ä¾›ä¸‹ä¸€æ­¥ä¸Šä¼ 
        echo "TARGET_FILENAME=$PDF_FILE" >> $GITHUB_ENV
        
        echo "ðŸŽ‰ Generated PDF: $PDF_FILE"

    - name: Upload to Google Drive
      env:
        GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
        GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
        GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        TARGET_FILENAME: ${{ env.TARGET_FILENAME }}
      run: |
        python tools/upload_to_drive.py
