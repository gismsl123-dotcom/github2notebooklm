name: Sync to NotebookLM Drive

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # 允许手动触发
    inputs:
      target_path:
        description: '要扫描的路径 (例如 src/ 或 .)'
        required: true
        default: '.'
        type: string

jobs:
  build-and-sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout content
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install google-api-python-client google-auth

    - name: Generate Context Markdown
      # 如果是 push 触发，默认用 '.'；如果是手动触发，用输入的路径
      run: |
        SCAN_PATH="${{ inputs.target_path }}"
        if [ -z "$SCAN_PATH" ]; then SCAN_PATH="."; fi
        
        echo "Scanning path: $SCAN_PATH"
        python repo2txt.py "$SCAN_PATH" -o codebase_context.md

    - name: Upload to Google Drive
      env:
        GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      run: |
        python upload_to_drive.py
